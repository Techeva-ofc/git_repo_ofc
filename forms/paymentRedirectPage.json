{
    "className": "org.joget.apps.form.model.Form",
    "elements": [{
        "className": "org.joget.apps.form.model.Section",
        "elements": [{
            "className": "org.joget.apps.form.model.Column",
            "elements": [
                {
                    "className": "org.joget.apps.form.lib.HiddenField",
                    "properties": {
                        "id": "orderReferenceIdField",
                        "useDefaultWhenEmpty": "",
                        "validator": {
                            "className": "",
                            "properties": {}
                        },
                        "value": "#requestParam.ref#",
                        "workflowVariable": ""
                    }
                },
                {
                    "className": "org.joget.apps.form.lib.CustomHTML",
                    "properties": {
                        "autoPopulate": "",
                        "id": "message",
                        "label": "",
                        "value": "<!DOCTYPE html>\r\n<html>\r\n<head>\r\n<meta name=\"viewport\" content=\"width=device-width, initial-scale=1\">\r\n<style>\r\n.alert {\r\n  padding: 20px;\r\n  background-color: #f44336;\r\n  color: white;\r\n  opacity: 1;\r\n  transition: opacity 0.6s;\r\n  margin-bottom: 15px;\r\n}\r\n\r\n.alert.success {background-color: #04AA6D;}\r\n.alert.info {background-color: #2196F3;}\r\n.alert.warning {background-color: #ff9800;}\r\n\r\n.closebtn {\r\n  margin-left: 15px;\r\n  color: white;\r\n  font-weight: bold;\r\n  float: right;\r\n  font-size: 22px;\r\n  line-height: 20px;\r\n  cursor: pointer;\r\n  transition: 0.3s;\r\n}\r\n\r\n.closebtn:hover {\r\n  color: black;\r\n}\r\n<\/style>\r\n<\/head>\r\n<body>\r\n\r\n<!--<h2>Alert Messages<\/h2>-->\r\n<!--<p>Click on the \"x\" symbol to close the alert message.<\/p>-->\r\n<!--<div class=\"alert\">\r\n  <span class=\"closebtn\">&times;<\/span>  \r\n  <strong>Danger!<\/strong> Indicates a dangerous or potentially negative action.\r\n<\/div>-->\r\n\r\n<div class=\"alert success\">\r\n  <span class=\"closebtn\">&times;<\/span>  \r\n  <strong>Success!<\/strong> Thankyou Payment successful.\r\n<\/div>\r\n\r\n<!--<div class=\"alert info\">\r\n  <span class=\"closebtn\">&times;<\/span>  \r\n  <strong>Info!<\/strong> Indicates a neutral informative change or action.\r\n<\/div>-->\r\n\r\n<!--<div class=\"alert warning\">\r\n  <span class=\"closebtn\">&times;<\/span>  \r\n  <strong>Warning!<\/strong> Indicates a warning that might need attention.\r\n<\/div>-->\r\n\r\n<script>\r\nvar close = document.getElementsByClassName(\"closebtn\");\r\nvar i;\r\n\r\nfor (i = 0; i < close.length; i++) {\r\n  close[i].onclick = function(){\r\n    var div = this.parentElement;\r\n    div.style.opacity = \"0\";\r\n    setTimeout(function(){ div.style.display = \"none\"; }, 600);\r\n  }\r\n}\r\n<\/script>\r\n\r\n<\/body>\r\n<\/html>"
                    }
                }
            ],
            "properties": {"width": "100%"}
        }],
        "properties": {
            "comment": "",
            "id": "paymentRedirectPage",
            "join": "",
            "label": "Payment Redirect Form",
            "loadBinder": {
                "className": "",
                "properties": {}
            },
            "permission": {
                "className": "",
                "properties": {}
            },
            "permissionReadonly": "",
            "readonly": "",
            "readonlyLabel": "",
            "regex": "",
            "reverse": "",
            "storeBinder": {
                "className": "",
                "properties": {}
            },
            "visibilityControl": "",
            "visibilityValue": ""
        }
    }],
    "properties": {
        "description": "",
        "id": "paymentRedirectPage",
        "loadBinder": {
            "className": "org.joget.apps.form.lib.BeanShellFormBinder",
            "properties": {
                "autoHandleFiles": "",
                "autoHandleWorkflowVariable": "true",
                "cacheInterval": "",
                "script": "import java.io.IOException;\r\nimport okhttp3.OkHttpClient;\r\nimport okhttp3.Request;\r\nimport okhttp3.Response;\r\nimport org.joget.apps.form.model.*;\r\nimport org.joget.apps.form.service.*;\r\nimport java.sql.*;\r\nimport java.util.*;\r\nimport org.apache.commons.collections.SequencedHashMap;\r\nimport java.sql.Connection;\r\nimport java.sql.PreparedStatement;\r\nimport java.sql.ResultSet;\r\nimport java.sql.SQLException;\r\nimport javax.sql.DataSource;\r\nimport org.joget.apps.app.model.AppDefinition;\r\nimport org.joget.apps.app.service.AppService;\r\nimport org.joget.apps.app.service.AppUtil;\r\nimport org.joget.apps.form.model.Element;\r\nimport org.joget.apps.form.model.FormData;\r\nimport org.joget.apps.form.model.FormRow;\r\nimport org.joget.apps.form.model.FormRowSet;\r\nimport org.joget.apps.form.model.FormStoreBinder;\r\nimport org.joget.apps.form.service.FormUtil;\r\nimport org.joget.plugin.base.PluginManager;\r\nimport org.joget.commons.util.LogUtil;\r\nimport org.json.JSONArray;\r\nimport org.json.JSONObject;\r\n\r\nString orderReference = \"\";\r\nString access_token =\"\";\r\nString orderStatus = \"\";\r\n\r\n\r\n//Here we are fetching the access token and orderReference from database\r\npublic  getOrderDetails() {\r\n\r\nString orderRefrenceFormUrl = \"#requestParam.ref#\";\r\nSystem.out.println(\"Reference Ref \"+orderRefrenceFormUrl );\r\n try {\r\n     \r\n    Class.forName(\"com.mysql.jdbc.Driver\").newInstance();\r\n    Connection  con = DriverManager.getConnection(\"jdbc:mysql://localhost:3307/jwdb?characterEncoding=UTF-8\", \"root\", \"\");\r\n    PreparedStatement preparedStatement = con.prepareStatement(\"SELECT * FROM app_fd_ofc_serreqs_tab WHERE c_orderReference = ?\");\r\n    preparedStatement.setString(1, orderRefrenceFormUrl);\r\n    ResultSet resultSet = preparedStatement.executeQuery();\r\n\r\n    while (resultSet.next()) {\r\n          orderReference = resultSet.getString(\"c_orderReference\");\r\n          access_token = resultSet.getString(\"c_bearer_access_token\");\r\n        // process the data\r\n    }\r\n LogUtil.info(\"ORDER Status  orderReference -:\", orderReference) ;\r\n //LogUtil.info(\"ORDER Status  access_token -:\", access_token) ;\r\n    resultSet.close();\r\n    preparedStatement.close();\r\n    con.close();\r\n} catch (SQLException e) {\r\n    e.printStackTrace();\r\n}\r\n}\r\n// get orderDetails\r\n getOrderDetails();\r\n\r\n\r\n// Here we are creating request for order status retrive API\r\npublic   getOrderStatus() {\r\n\r\n\t\tOkHttpClient okHttpClient = new OkHttpClient();\r\n\t\tString OrderStatusResponse = null;\r\n        String outletId = \"a2c3b529-68c7-44eb-8a2a-3aeb12d83ae6/orders\";\r\n    \tString orderStausUrl = \"https://api-gateway.sandbox.ngenius-payments.com/transactions/outlets/\"+outletId+\"/\"+orderReference;\r\n\r\n     \tRequest request1 = new Request.Builder().url(orderStausUrl).get().addHeader(\"Authorization\", access_token).build();\r\n\r\n\t\ttry {\r\n\t\t\tResponse response1 = okHttpClient.newCall(request1).execute();\r\n\t\t\tOrderStatusResponse = response1.body().string();\r\n\t\t\tJSONObject json = new JSONObject(OrderStatusResponse);\r\n\t\t\tLogUtil.info(\"ORDER Status Retrive -:\", OrderStatusResponse) ;\r\n\t\t\t\r\n\t\t    JSONObject jsonStatus = new JSONObject(OrderStatusResponse);\r\n\t\t   // System.out.println(\"orderStatus Redirect :  \" + orderStatus);\r\n\t\t    orderStatus = jsonStatus.getJSONObject(\"_embedded\").getJSONArray(\"payment\").getJSONObject(0).getString(\"state\");\r\n\t     \tSystem.out.println(\"orderStatus :  \" + orderStatus);\r\n\t \t               \r\n\t\t} catch (IOException e) {\r\n\t\t\t// TODO Auto-generated catch block\r\n\t\t\te.printStackTrace();\r\n\t\t}\r\n\r\n\t}\r\n\t// calling getOrderStatus method\r\n\t getOrderStatus();\r\n\t\r\n//here we are update the order status\r\npublic updateOrderStatus(String orderStaus){\r\n    \r\n    try {\r\n\t\t\tClass.forName(\"com.mysql.jdbc.Driver\").newInstance();\r\n\t\t\tConnection con = DriverManager.getConnection(\"jdbc:mysql://localhost:3307/jwdb?characterEncoding=UTF-8\",\r\n\t\t\t\t\t\"root\", \"\");\r\n\t\t\tif (!con.isClosed()) {\r\n\t\t\t    \r\n                String paymentComplete =\"Payment Completed\";\r\n                String paymentPending =\"Payment Pending\";\r\n                \r\n\t\t\t\t// create the java mysql update preparedstatement  c_bearer_access_token\r\n\t\t\t\tString query = \"update app_fd_ofc_serreqs_tab set c_status = ? where c_orderReference = ?\";\r\n\t\t\t\tPreparedStatement preparedStmt = con.prepareStatement(query);\r\n\t\t\t\t\r\n\t\t\t\tif(orderStaus.equalsIgnoreCase(\"PURCHASED\")){\r\n\t\t\t\tpreparedStmt.setString(1, paymentComplete);\r\n\t\t\t}else{\r\n\t\t\t    \tpreparedStmt.setString(1, paymentPending);\r\n\t\t\t}\r\n\t\t\t\tpreparedStmt.setString(2, orderReference);\r\n\t\t\t \r\n\t\t\t\t// execute the java preparedstatement\r\n\t\t\t\tpreparedStmt.executeUpdate();\r\n\r\n\t\t\t\tcon.close();\r\n\t\t\t} else {\r\n\t\t\t\tSystem.out.println(\"Connection Problem\");\r\n\t\t\t}\r\n\t\t} catch (Exception ex) {\r\n\t\t\tex.printStackTrace();\r\n\r\n\t\t}finally{\r\n\t\t//local url    \r\n       String redirectUrl = \"http://127.0.0.1:8080/jw/web/userview/ofc_app/v/_/serReqForm_crud\";\r\n       //cloud url\r\n       ////String redirectUrl = \"https://concordia.cloud.joget.com/jw/web/userview/ofc_app/v/_/serReqForm_crud\";\r\n    \t// Execute payment link\r\n\t  java.awt.Desktop.getDesktop().browse(java.net.URI.create(redirectUrl));\r\n\t}\r\n}\r\n\t\r\n  updateOrderStatus(orderStatus);\t\r\n\t\r\n",
                "useAjax": ""
            }
        },
        "name": "Payment Redirect Page",
        "noPermissionMessage": "",
        "permission": {
            "className": "",
            "properties": {}
        },
        "postProcessor": {
            "className": "",
            "properties": {}
        },
        "postProcessorRunOn": "create",
        "storeBinder": {
            "className": "org.joget.apps.form.lib.WorkflowFormBinder",
            "properties": {}
        },
        "tableName": "payment_redirect_tab"
    }
}